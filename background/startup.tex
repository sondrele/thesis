\section{Startup}
\label{sec:back:startup}

This section describes the process of starting a program on an embedded system.
The \textbf{main} function is usually considered the starting point of a program.
This is sometimes true from the point of view of the programmer, but as we will see in this section usually it is not.
This section looks at what happens before the program reaches the main function.

\subsection{Prelude}

Before we look at the start of execution, lets look at the process between compilation and execution.
The compiler outputs objectfiles which the linker combines into a \textbf{elf} file.
This file is loaded into the microcontrollers ROM Flash memory.
Then the reset signal is sent to the CPU to start execution.

\subsection{Executable and Linkable File Format}
%\todo{Reference: http://infocenter.arm.com/help/topic/com.arm.doc.ihi0044e/IHI0044E\_aaelf.pdf}
\textbf{elf} is a file format for storing code and data for a program.
This file format can be loaded onto a microcontroller and executed.
For our purposes, this format defines three interesting sections, namely \textbf{.text}, \textbf{.data} and \textbf{.bss}.
\autoref{fig:elf} describes the contents of the these sections an \textbf{elf} file.

\begin{figure}[H]
  \centering
  \begin{tabular}{|l|l|}
    \hline
    EFL Header & Header describing size of sections \\
    \hline
    \textbf{.bss} & Logical section for zero-initialized data \\
    \hline
    \textbf{.text} & Read-only section for code and constants \\
    \hline
    \textbf{.data} & Section containing values for non-zero initialized data \\
    \hline
  \end{tabular}
  \caption{Sections of elf file format}
  \label{fig:elf}
\end{figure}

The \textbf{.text} section contains the program code and any read-only data defined in the code.
Strings are for instance stored in the \textbf{.text} section as read-only.
The \textbf{.data} section contains the values for non-zero initialized data.
The \textbf{.bss} section is a logical section so it is not really stored in the file.
The header specfies the size of the \textbf{.bss} section which describes the size of the zero-initialized data in the program.

\subsection{Before main}

Before the \textbf{main} function executes, all static data must be initialized.
The data is divided into two categories; zero and non-zero initialized.
The non-zero initialized data are contained either in the \textbf{.text} (read-only-data) or \textbf{.data} sections of the \textbf{elf} binary.
On the chip the \textbf{.data} section resides in flash memory, as these data structures might change at runtime they must be copied into RAM.
The \textbf{.text} section contains the instructions and read-only data, this data does not need to be copied as thet can be read directly from flash at runtime.
All zero initialized data are represented by the \textbf{.bss} section in the \textbf{elf} binary.
A portion of RAM corresonding to the size of the \textbf{.bss} section must be set to zero.

Copying the \textbf{.data} section into RAM is handled by the \textbf{ResetHandler} function in \autoref{lst:reset-handler}
The function is the real entry point of the program and is executed when the CPU receives the reset signal.

\begin{listing}[H]
\begin{minted}{c}
// Variables set in linker script
extern etext;      // address of .data segment in FLASH
extern data_start; // start of .data segement in RAM
extern data_end;   // end of .data segment in RAM
void ResetHandler() {
  for (i=0; i<data_end - data_start; i++){
    RAM[data_start + i] = FLASH[etext+i];
  }
  _start();
}
\end{minted}
\caption{ResetHandler}
\label{lst:reset-handler}
\end{listing}

When the \textbf{ResetHandler} has copied the non-zero initialized data into RAM it calls the \textbf{\_start} function in the C runtime.
The \textbf{\_start} function finds the size of the \textbf{.bss} section which describes the size of zero-initialized area in RAM.
It then calls on the \textbf{memset} function to zero out the RAM.
\textbf{\_start} then goes on to call the \textbf{main} function supplied by the programmer.

\begin{listing}[H]
\begin{minted}{c}
// Variables set in linker script
bss_start; // start of .bss segment in RAM
bss_end;   // end of .bss segment in RAM

void _start() {
  memset(bss_start, 0, bss_end - bss_start);
  main(); // User supplied main function
}
\end{minted}
\caption{start routine}
\label{lst:start}
\end{listing}
